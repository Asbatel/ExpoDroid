package malware.scanner.Activities;

import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.support.design.widget.NavigationView;
import android.support.v4.app.Fragment;
import android.support.v4.app.FragmentManager;
import android.support.v4.app.FragmentPagerAdapter;
import android.support.v4.app.FragmentTransaction;
import android.support.v4.content.FileProvider;
import android.support.v4.view.ViewPager;
import android.support.v4.widget.DrawerLayout;
import android.support.v7.app.ActionBar;
import android.support.v7.app.ActionBarDrawerToggle;
import android.support.v7.app.AppCompatActivity;
import android.support.v7.widget.Toolbar;
import android.util.Log;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;

import java.io.File;
import java.util.ArrayList;

import malware.scanner.Fragments.MalwareDetailsFragment;
import malware.scanner.Fragments.MalwareFamilyFragment;
import malware.scanner.Fragments.MalwareScoreFragment;
import malware.scanner.R;
import malware.scanner.Utils.Constants;

public class MalwareActivity extends AppCompatActivity implements View.OnClickListener {

    private Button continueButton, abortButton;
    private final String[] PAGE_TITLES = new String[]{
            Constants.MALWARE_SCORE,
            Constants.MALWARE_DETAILS,
            Constants.MALWARE_FAMILY
    };


    private final Fragment[] PAGES = new Fragment[]{
            new MalwareScoreFragment(),
            new MalwareDetailsFragment(),
            new MalwareFamilyFragment(),
    };


    private ViewPager mViewPager;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_malware);
        setAttributes();
        setTab();
    }

    private void setTab() {
        final ActionBar actionBar = getSupportActionBar();
        actionBar.setNavigationMode(ActionBar.NAVIGATION_MODE_TABS);
        actionBar.setTitle(Constants.MALWARE_RESULT);

        actionBar.setBackgroundDrawable(getResources().getDrawable(R.color.orange));
        actionBar.setStackedBackgroundDrawable(getResources().getDrawable(R.color.orange));


        ActionBar.TabListener tabListener = new ActionBar.TabListener() {

            @Override
            public void onTabSelected(ActionBar.Tab tab, FragmentTransaction ft) {
                mViewPager.setCurrentItem(tab.getPosition());

            }

            @Override
            public void onTabUnselected(ActionBar.Tab tab, FragmentTransaction ft) {

            }

            @Override
            public void onTabReselected(ActionBar.Tab tab, FragmentTransaction ft) {

            }
        };

        for (int i = 0; i < PAGES.length; i++) {
            actionBar.addTab(actionBar.newTab().setText(PAGE_TITLES[i]).setTabListener(tabListener));
            actionBar.setSplitBackgroundDrawable(getResources().getDrawable(R.color.orange));
        }

        mViewPager.setOnPageChangeListener(new ViewPager.SimpleOnPageChangeListener() {
            @Override
            public void onPageSelected(int position) {
                getSupportActionBar().setSelectedNavigationItem(position);
            }
        });
    }

    private void setAttributes() {
        continueButton = (Button) findViewById(R.id.continueB);
        abortButton = (Button) findViewById(R.id.abortB);
        continueButton.setOnClickListener(this);
        abortButton.setOnClickListener(this);
        mViewPager = (ViewPager) findViewById(R.id.viewpager);
        mViewPager.setAdapter(new MyPagerAdapter(getSupportFragmentManager()));

    }


    @Override
    public void onBackPressed() {
        this.finish();
    }


    @Override
    public void onClick(View v) {

        File apkFile = new File(getExternalFilesDir(null) + File.pathSeparator + Constants.CHECK_APK_NAME);

        if (v == continueButton) {
            //SharedPreferencesUtils.setItInstalled(true, getApplicationContext());
            if (apkFile.exists()) {
                Uri uri = FileProvider.getUriForFile(MalwareActivity.this,
                        getApplicationContext().getPackageName() + ".malware.scanner.provider", apkFile);
                Intent promptInstall = new Intent(Intent.ACTION_VIEW)
                        .setDataAndType(uri, "application/vnd.android.package-archive");
                promptInstall.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
                promptInstall.putExtra(Constants.IS_BENIGN, true);
                startActivity(promptInstall);
            }

        } else if (v == abortButton) {
            //SharedPreferencesUtils.setItInstalled(false, getApplicationContext());
            if (apkFile.exists()) {
                apkFile.delete();
            }
        }

        finish();
    }

    public class MyPagerAdapter extends FragmentPagerAdapter {

        public MyPagerAdapter(FragmentManager fragmentManager) {
            super(fragmentManager);
        }

        @Override
        public android.support.v4.app.Fragment getItem(int i) {
            return PAGES[i];
        }

        @Override
        public int getCount() {
            return PAGES.length;
        }

        @Override
        public CharSequence getPageTitle(int position) {
            return PAGE_TITLES[position];
        }

    }
}
